<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin - Silent Portal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* --- CSS STYLES --- */
        :root { --bg-dark: #0f172a; --bg-card: #1e293b; --primary: #3b82f6; --text-main: #f8fafc; --text-muted: #94a3b8; --border: #334155; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Outfit', sans-serif; background: var(--bg-dark); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }
        ::-webkit-scrollbar { width: 4px; height: 4px; } ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; } ::-webkit-scrollbar-track { background: transparent; }
        
        .sidebar { width: 260px; background: var(--bg-card); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 50; transition: transform 0.3s ease; }
        .brand { padding: 30px; text-align: center; border-bottom: 1px solid var(--border); background: rgba(15, 23, 42, 0.5); }
        .brand h3 { margin: 15px 0 0; color: white; letter-spacing: 3px; font-weight: 700; background: linear-gradient(to right, #3b82f6, #8b5cf6); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-menu { flex: 1; padding: 20px 0; overflow-y: auto; }
        .nav-item { padding: 16px 25px; cursor: pointer; color: var(--text-muted); display: flex; align-items: center; gap: 15px; transition: all 0.2s; font-weight: 500; border-left: 4px solid transparent; }
        .nav-item:hover, .nav-item.active { background: rgba(59, 130, 246, 0.08); color: white; border-left-color: var(--primary); }
        .nav-item i { width: 20px; text-align: center; }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 40; display: none; backdrop-filter: blur(2px); }
        
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; width: 100%; }
        .top-bar { padding: 15px 20px; background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 30; gap: 15px; }
        .mobile-menu-btn { display: none; background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 5px; }
        .view { display: none; height: 100%; overflow-y: auto; padding: 20px; padding-bottom: 80px; }
        .view.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .card { background: linear-gradient(145deg, var(--bg-card), #182234); padding: 20px; border-radius: 16px; border: 1px solid var(--border); position: relative; overflow: hidden; transition: 0.3s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .card h4 { margin: 0 0 10px; font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 700; letter-spacing: 1px; }
        .card h2 { margin: 0; font-size: 28px; font-weight: 700; color: white; }
        .card-icon { position: absolute; right: 20px; top: 20px; font-size: 30px; opacity: 0.1; color: white; }
        
        .table-wrapper { background: var(--bg-card); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 20px; display: flex; flex-direction: column; }
        .table-header { padding: 15px 20px; border-bottom: 1px solid var(--border); font-size: 18px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; width: 100%; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: rgba(15, 23, 42, 0.8); padding: 15px; text-align: left; font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 600; white-space: nowrap; }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 14px; color: var(--text-main); white-space: nowrap; }
        tr:hover td { background: rgba(255,255,255,0.02); }
        
        .badge { padding: 5px 10px; border-radius: 6px; font-size: 10px; font-weight: 600; text-transform: uppercase; display: inline-block; letter-spacing: 0.5px; }
        .badge-pending { background: rgba(245, 158, 11, 0.1); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.2); }
        .badge-success { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.2); }
        .badge-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }
        .badge-proc { background: rgba(59, 130, 246, 0.1); color: var(--primary); border: 1px solid rgba(59, 130, 246, 0.2); }
        .btn { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; color: white; margin-right: 5px; font-size: 13px; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; transition: 0.2s; white-space: nowrap; }
        .bg-grn { background: var(--success); } .bg-red { background: var(--danger); } .bg-blu { background: var(--primary); } .bg-dark { background: #334155; border: 1px solid var(--border); }
        .btn:active { transform: scale(0.96); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); padding: 20px; }
        #login-overlay { z-index: 10000 !important; }

        .modal-box { background: var(--bg-card); padding: 25px; border-radius: 16px; width: 100%; max-width: 500px; border: 1px solid var(--border); position: relative; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .modal-inp { width: 100%; padding: 14px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 10px; color: white; margin: 8px 0; box-sizing: border-box; font-size: 14px; }
        .modal-inp:focus { border-color: var(--primary); }
        .ctrl-btn { padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 11px; font-weight: 600; border: none; background: transparent; color: var(--text-muted); transition: 0.2s; display: flex; align-items: center; gap: 6px; white-space: nowrap; }
        .ctrl-btn.active-on { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .ctrl-btn.active-off { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .ctrl-btn.active-maint { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        
        .simple-ctrl { display: flex; gap: 10px; margin-top: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; flex-wrap: wrap; }
        .simple-inp { background: var(--bg-dark); border: 1px solid var(--border); color: white; padding: 10px; border-radius: 8px; width: 100%; font-weight: bold; text-align: center; }
        textarea.simple-inp { resize: vertical; min-height: 60px; text-align: left; }
        
        .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(16px); }

        #toast-box { position: fixed; top: 20px; right: 20px; z-index: 20000; display: flex; flex-direction: column; gap: 10px; max-width: 90%; }
        .toast { background: var(--bg-card); border-left: 4px solid var(--primary); color: white; padding: 16px 20px; border-radius: 8px; min-width: 280px; display: flex; align-items: center; gap: 15px; border: 1px solid var(--border); animation: slideIn 0.3s forwards; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        .chat-copy-btn { margin-left:8px; cursor:pointer; color:rgba(255,255,255,0.4); font-size:12px; background:none; border:none; padding: 5px; }
        .info-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 700; display: block; margin-top: 10px; margin-bottom: 5px; }
        .info-val { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; border: 1px solid var(--border); font-size: 14px; word-break: break-all; }
        .proof-img { max-width: 100%; border-radius: 8px; border: 1px solid var(--border); }
        .admin-display-label { display: block; }
        
        .quick-replies-wrapper { display: flex; gap: 8px; padding: 10px 20px; overflow-x: auto; background: var(--bg-card); border-top: 1px solid var(--border); white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .qr-chip { background: #334155; color: var(--text-main); padding: 5px 12px; border-radius: 20px; font-size: 11px; cursor: pointer; border: 1px solid var(--border); transition: 0.2s; }
        .qr-chip:hover { background: var(--primary); border-color: var(--primary); color: white; }
        .msg-copy-icon { margin-left: 8px; font-size: 12px; opacity: 0.5; cursor: pointer; color: white; transition: 0.2s; }
        .msg-copy-icon:hover { opacity: 1; transform: scale(1.1); }

        /* --- NEW: INTERNET CHECK OVERLAY --- */
        #offline-warning-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.98); z-index: 20001; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: #ef4444; backdrop-filter: blur(5px); }
        .offline-icon { font-size: 80px; margin-bottom: 20px; animation: bounce 2s infinite; }
        
        #dev-surveillance-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.98); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: #ef4444; pointer-events: auto; cursor: not-allowed; user-select: none; }
        .pulse-text { animation: pulse 1.5s infinite; font-size: 24px; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; border: 2px solid #ef4444; padding: 20px; border-radius: 10px; background: rgba(239, 68, 68, 0.1); max-width: 80%; box-shadow: 0 0 20px rgba(239, 68, 68, 0.5); }
        @keyframes pulse { 0% { opacity: 0.8; box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); transform: scale(1); } 50% { transform: scale(1.05); } 70% { opacity: 1; box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 100% { opacity: 0.8; box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); transform: scale(1); } }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-20px);} 60% {transform: translateY(-10px);} }

        @media (max-width: 768px) {
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 280px; transform: translateX(-100%); box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
            .sidebar.active { transform: translateX(0); }
            .sidebar-overlay.active { display: block; }
            .mobile-menu-btn { display: block; }
            .main { width: 100%; }
            .top-bar { padding: 10px 15px; flex-direction: column; align-items: stretch; gap: 10px; height: auto; }
            .top-bar > div:first-child { justify-content: space-between; }
            #global-search { display: block !important; width: 100% !important; max-width: none !important; margin-top: 5px; }
            .view { padding: 15px; }
            .stats-grid { grid-template-columns: 1fr; }
            #categories .card { width: 100% !important; order: 1; }
            #categories .table-wrapper { order: 2; }
            #categories > div { display: flex !important; flex-direction: column; }
            .admin-display-label { display: none; }
            .modal-box { width: 95%; max-height: 85vh; padding: 20px; }
            #chat-modal .modal-box { width: 100%; height: 100%; border-radius: 0; max-height: 100%; }
            .btn { padding: 12px 15px; font-size: 14px; }
            .btn i { font-size: 16px; }
            #login-overlay { align-items: flex-start; padding-top: 50px; overflow-y: auto; }
        }
    </style>
</head>
<body>
    <div id="toast-box"></div>
    <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- INTERNET CHECK OVERLAY (Added) -->
    <div id="offline-warning-overlay">
        <i class="fas fa-wifi-slash offline-icon"></i>
        <h2 style="margin: 0; color: white;">NO INTERNET CONNECTION</h2>
        <p style="color: #94a3b8; margin-top: 10px;">Please check your network settings to use the Admin Panel.</p>
    </div>

    <!-- SURVEILLANCE OVERLAY -->
    <div id="dev-surveillance-overlay">
        <i class="fas fa-user-secret" style="font-size: 100px; margin-bottom: 30px; color: #ef4444;"></i>
        <div class="pulse-text">SYSTEM LOCKED BY DEVELOPER<br><span style="font-size: 14px; font-weight: normal; margin-top: 10px; display: block; color: white;">Panel Surveillance in Progress</span></div>
        <p style="color: #94a3b8; margin-top: 20px; font-size: 12px; letter-spacing: 1px;">PLEASE KEEP QUIET & WAIT FOR ACCESS</p>
    </div>

    <!-- Login Overlay -->
    <div id="login-overlay" class="modal-overlay" style="display: flex;">
        <div class="modal-box" style="text-align:center; max-width: 350px;">
            <div style="width:70px; height:70px; margin:0 auto 20px; border-radius:50%; background:var(--primary); display:flex; justify-content:center; align-items:center; font-size:30px; color:white;">A</div>
            <h2 style="margin:0 0 10px; color: white;">Admin Portal</h2>
            <select id="adm-id" class="modal-inp" onchange="togglePasscodeField()">
                <option value="" disabled selected>Select Role...</option>
                <option value="HELIX PANEL" style="color:var(--primary); font-weight:bold;">HELIX PANEL</option>
                <option value="Developer" style="color:var(--danger); font-weight:bold;">Developer</option>
                <option value="Moderator 1">Moderator 1</option>
                <option value="Moderator 2">Moderator 2</option>
                <option value="Moderator 3">Moderator 3</option>
                <option value="Moderator 4">Moderator 4</option>
                <option value="Moderator 5">Moderator 5</option>
            </select>
            <input id="ae" class="modal-inp" placeholder="Email Address">
            <input id="ap" class="modal-inp" type="password" placeholder="Password">
            <input id="adm-passcode" class="modal-inp" type="password" placeholder="Passcode (Required)" style="border-color: var(--primary);">
            <button id="adm-login-btn" onclick="admLog()" class="btn bg-blu" style="width:100%; padding:14px; margin-top:20px; justify-content: center; font-size: 16px;">LOGIN DASHBOARD</button>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="brand"><h3>SILENT</h3></div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="setView('dash', this)"><i class="fas fa-chart-pie"></i> Dashboard</div>
            <div id="nav-services" class="nav-item" onclick="setView('services', this)"><i class="fas fa-th-large"></i> Services</div>
            <div id="nav-categories" class="nav-item" onclick="setView('categories', this)"><i class="fas fa-tags"></i> Categories</div>
            <div class="nav-item" onclick="setView('orders', this)"><i class="fas fa-shopping-bag"></i> Orders <span id="nav-ord-count" class="badge badge-danger" style="margin-left:auto; display:none;">0</span></div>
            <div class="nav-item" onclick="setView('logs', this)"><i class="fas fa-history"></i> Activity Logs</div>
            <div class="nav-item" onclick="setView('bal', this)"><i class="fas fa-wallet"></i> Deposits <span id="nav-bal-count" class="badge badge-pending" style="margin-left:auto; display:none;">0</span></div>
            <div class="nav-item" onclick="setView('users', this)"><i class="fas fa-users"></i> Users DB <span id="nav-usr-count" class="badge badge-pending" style="margin-left:auto; display:none;">0</span></div>
            <div id="dev-nav-item" class="nav-item" onclick="setView('dev-ctrl', this)" style="display:none; color: #ec4899;"><i class="fas fa-user-secret"></i> Developer Control</div>
            <div style="padding: 15px; border-top: 1px solid var(--border); margin-top: 10px;">
               <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 5px;">SYSTEM STATUS</div>
               <div style="display:flex; gap:5px;">
                    <button class="ctrl-btn" id="btn-active" onclick="changeSystemStatus('active')" style="flex:1; justify-content:center; border:1px solid var(--border);">ON</button>
                    <button class="ctrl-btn" id="btn-maint" onclick="openMaintModal()" style="flex:1; justify-content:center; border:1px solid var(--border);">MAINT</button>
                    <button class="ctrl-btn" id="btn-off" onclick="changeSystemStatus('off')" style="flex:1; justify-content:center; border:1px solid var(--border);">OFF</button>
               </div>
            </div>
        </div>
        <div class="nav-item" onclick="logout()" style="margin-top:auto; border-top: 1px solid var(--border); color: var(--danger); padding: 20px 25px;"><i class="fas fa-sign-out-alt"></i> Sign Out</div>
    </div>
    
    <!-- Main Content -->
    <div class="main">
        <div class="top-bar">
            <div style="display:flex; align-items:center; gap:15px; width:100%; justify-content: space-between;">
                <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                <button id="btn-forms" class="btn bg-dark" onclick="openFormEditor()" style="white-space:nowrap; margin-left: auto;"><i class="fas fa-edit"></i> <span class="admin-display-label" style="display:inline;">Forms</span></button>
                <div style="display:flex; align-items:center; gap:10px; margin-left: 10px;">
                    <div style="text-align:right;" class="admin-display-label"><span id="curr-adm-display" style="font-weight:600;">Admin</span></div>
                    <div style="width:10px; height:10px; background:var(--success); border-radius:50%;"></div>
                </div>
            </div>
            <!-- FIXED: Global Search for ALL VIEWS -->
            <div class="filter-container" style="display: flex; gap: 10px; width: 100%;">
                <input type="text" id="global-search" onkeyup="globalSearch()" placeholder="Search anything here..." class="modal-inp" style="margin:0; flex: 2; padding:10px 15px; border-color: var(--primary);">
            </div>
        </div>
        
        <!-- DASHBOARD VIEW -->
        <div id="dash" class="view active">
            <div class="stats-grid">
                <div class="card"><h4>TOTAL USERS</h4><h2 id="c-usr">0</h2><i class="fas fa-users card-icon"></i></div>
                <div class="card"><h4>REAL DB ORDERS</h4><h2 id="c-total-real">0</h2><i class="fas fa-database card-icon"></i></div>
                <div class="card"><h4>TODAY'S ORDERS</h4><h2 id="c-today-real" style="color:var(--success)">0</h2><i class="fas fa-calendar-day card-icon"></i></div>
                <div class="card"><h4>PENDING ORDERS</h4><h2 id="c-pen" style="color:var(--warning)">0</h2><i class="fas fa-clock card-icon"></i></div>
                <div class="card"><h4>PENDING DEPOSITS</h4><h2 id="c-pen-money" style="color:var(--warning)">৳ 0</h2><i class="fas fa-hand-holding-usd card-icon"></i></div>
                
                <div class="card" id="card-super-tools" style="display:none; border-color: #8b5cf6; background:linear-gradient(145deg, #2e1065, #1e293b);">
                    <div style="display:flex; justify-content:space-between;"><h4 style="color: #c4b5fd;">SUPER ADMIN TOOLS</h4><i class="fas fa-toolbox" style="color: #8b5cf6;"></i></div>
                    <button onclick="backupDB()" class="btn bg-dark" style="width:100%; margin-bottom:15px; border:1px solid #8b5cf6; color: #c4b5fd;"><i class="fas fa-cloud-download-alt"></i> Download Full Backup</button>
                    <h4 style="margin: 5px 0 5px; color: #f8fafc; font-size:11px;">SEND GLOBAL ALERT</h4>
                    <div class="simple-ctrl" style="margin-top:0;"><input id="global-alert-text" class="simple-inp" placeholder="Type alert message..."><button class="btn bg-blu" onclick="sendGlobalAlert()" style="background:#8b5cf6;">SEND</button></div>
                </div>

                <div class="card" style="border-color:#ec4899; background:linear-gradient(145deg, #4a1d33, #1e293b);">
                    <div style="display:flex; justify-content:space-between; align-items:center;"><h4 style="margin:0; color:#ec4899;">POPUP NOTICE</h4><span id="popup-badge" class="badge bg-dark">Hidden</span></div>
                    <div class="simple-ctrl" style="flex-direction:column; gap:8px;">
                        <textarea id="popup-text" class="simple-inp" placeholder="Enter urgent notice..."></textarea>
                        <div style="display:flex; gap:5px;"><button class="btn bg-grn" onclick="setPopup(true)" style="flex:1;">SHOW</button><button class="btn bg-red" onclick="setPopup(false)" style="flex:1;">HIDE</button></div>
                    </div>
                </div>

                <div class="card" style="border-color:var(--warning); background:linear-gradient(145deg, #3f2e1a, #1e293b);">
                    <h4 style="margin:0; color:var(--warning);">MARQUEE TEXT</h4>
                    <div class="simple-ctrl" style="flex-direction: column;"><input id="announce-inp" class="simple-inp" placeholder="Type notice..." style="text-align:left;"><button class="btn bg-grn" onclick="saveAnnouncement()" style="width:100px;">SAVE</button></div>
                </div>

                <div class="card" style="border-color:var(--primary); background:linear-gradient(145deg, #1e293b, #172554);">
                    <div style="display:flex; justify-content:space-between;"><h4 style="margin:0; color:var(--primary);">FAKE COUNTER</h4><h2 id="fake-display" style="margin:0; font-size:20px;">0</h2></div>
                    <div class="simple-ctrl">
                        <input id="fake-inp" class="simple-inp" type="number" placeholder="Base">
                        <div style="display:flex; gap:5px; width:100%;"><button class="btn bg-blu" onclick="updateFakeCount()" style="flex:1;"><i class="fas fa-save"></i></button><button id="fake-auto-btn" class="btn bg-dark" onclick="toggleFakeAuto()" style="flex:1;">Auto</button></div>
                    </div>
                </div>

                <div class="card" id="card-admin-map" style="display:none; border-color: #3b82f6; grid-column: 1 / -1;">
                     <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h4 style="margin:0; color:#93c5fd; font-size:14px;">ADMIN TEAM MAPPING (IP LOGS)</h4>
                        <span style="font-size:10px; background:rgba(59, 130, 246, 0.2); color:#93c5fd; padding:3px 8px; border-radius:4px;">Secure View</span>
                    </div>
                    <div style="overflow-x:auto;">
                        <table style="width:100%; min-width:300px;">
                            <thead><tr><th style="background:transparent; padding:5px; color:#94a3b8;">Role Name</th><th style="background:transparent; padding:5px; color:#94a3b8;">Connected Email</th><th style="background:transparent; padding:5px; color:#94a3b8;">IP Address</th><th style="background:transparent; padding:5px; color:#94a3b8;">Last Login</th></tr></thead>
                            <tbody id="admin-map-body"><tr><td colspan="4" style="text-align:center; padding:10px; color:#64748b;">Loading team data...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ORDERS VIEW -->
        <div id="orders" class="view">
            <div class="table-wrapper">
                <div class="table-header">
                    Manage Orders
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <select id="filter-status" class="modal-inp" style="margin:0; width: auto; padding: 8px; font-size:12px;" onchange="globalSearch()"><option value="all">All Status</option><option value="pending">Pending</option><option value="processing">Processing</option><option value="completed">Completed</option><option value="cancelled">Cancelled</option></select>
                        <select id="filter-service" class="modal-inp" style="margin:0; width: auto; padding: 8px; font-size:12px;" onchange="globalSearch()"><option value="all">All Services</option></select>
                    </div>
                </div>
                <div class="table-scroll">
                    <table id="table-orders"><thead><tr><th>ID</th><th>User</th><th>Service</th><th>Status</th><th>Date</th><th style="text-align:center;">Actions</th></tr></thead><tbody id="ord-list"></tbody></table>
                </div>
            </div>
        </div>
        
        <div id="services" class="view"><div class="table-wrapper"><div class="table-header">Manage Services <button id="btn-add-service" class="btn bg-blu" onclick="openServiceModal()">+ Add New</button></div><div class="table-scroll"><table id="table-services"><thead><tr><th>Icon</th><th>Name</th><th>Category</th><th>Key</th><th>Price</th><th id="th-status">Status</th><th id="th-actions">Actions</th></tr></thead><tbody id="svc-list"></tbody></table></div></div></div>
        <div id="categories" class="view"><div style="display:grid; grid-template-columns: 1fr 2fr; gap: 20px;"><div class="card" style="height: fit-content;"><h3 style="margin-top:0;">Add New Category</h3><input id="new-cat-inp" class="modal-inp" placeholder="Category Name"><button class="btn bg-blu" onclick="addCategory()" style="width:100%; justify-content:center;">ADD CATEGORY</button></div><div class="table-wrapper"><div class="table-header">Category List</div><div class="table-scroll"><table><thead><tr><th>Name</th><th style="text-align:right;">Action</th></tr></thead><tbody id="cat-list-body"></tbody></table></div></div></div></div>
        <div id="logs" class="view"><div class="table-wrapper"><div class="table-header">Admin Activity Logs</div><div class="table-scroll"><table id="table-logs"><thead><tr><th>Order ID</th><th>Action</th><th>Admin Name</th><th>Time</th></tr></thead><tbody id="log-list"></tbody></table></div></div></div>
        <div id="bal" class="view"><div class="table-wrapper"><div class="table-header">Deposit Requests</div><div class="table-scroll"><table id="table-deposits"><thead><tr><th>User / Mobile</th><th>TRX ID</th><th>Amount</th><th>Proof</th><th>Status</th><th style="text-align:center;">Actions</th></tr></thead><tbody id="bal-list"></tbody></table></div></div></div>
        <div id="users" class="view"><div class="table-wrapper"><div class="table-header">User Database</div><div class="table-scroll"><table id="table-users"><thead><tr><th>Name</th><th>Contact</th><th>Telegram</th><th>Email</th><th>Balance</th><th>Status</th><th style="text-align:center;">Actions</th></tr></thead><tbody id="usr-list"></tbody></table></div></div></div>
        
        <!-- DEV CONTROL -->
        <div id="dev-ctrl" class="view">
            <div class="stats-grid">
                <div class="card" style="border-color: var(--danger); background: linear-gradient(145deg, #3f0909, #1e293b);">
                    <h4 style="color:var(--danger)">Surveillance Mode (LOCKDOWN)</h4>
                    <p style="font-size:12px; color:var(--text-muted); margin-bottom:10px;"><b>STATUS:</b> <span id="dev-status-text">Inactive</span></p>
                    <div class="simple-ctrl"><input id="dev-code-inp" class="simple-inp" type="password" placeholder="Type: dev_surveillance_on"><button id="btn-dev-start" class="btn bg-red" onclick="toggleSurveillance(true)" style="width:100%">START SURVEILLANCE</button><button id="btn-dev-stop" class="btn bg-grn" onclick="toggleSurveillance(false)" style="width:100%; display:none;">STOP & UNLOCK</button></div>
                </div>

                <!-- ADD NEW ROLE SECTION -->
                <div class="card" style="border-color: #10b981;">
                    <h4 style="color: #6ee7b7;">Manage Roles</h4>
                    <p style="font-size:11px; color:var(--text-muted);">Add new Moderator roles here.</p>
                    <input id="new-role-name" class="modal-inp" placeholder="Role Name (e.g. Moderator 6)">
                    <button class="btn bg-grn" onclick="addNewRole()" style="width:100%;">ADD ROLE</button>
                </div>
                
                 <!-- AUTHORIZED ADMIN EMAILS -->
                 <div class="card" style="border-color: #f59e0b;">
                    <h4 style="color: #fbbf24;">Authorized Admin List</h4>
                    <p style="font-size:11px; color:var(--text-muted);">Allow specific G-Mails to log in as Roles.</p>
                    <input id="auth-admin-email" class="modal-inp" placeholder="Gmail (e.g. abc@gmail.com)">
                    <select id="auth-admin-role" class="modal-inp">
                         <option value="" disabled selected>Select Role...</option>
                         <option value="Moderator 1">Moderator 1</option>
                         <option value="Moderator 2">Moderator 2</option>
                         <option value="Moderator 3">Moderator 3</option>
                    </select>
                    <button class="btn bg-blu" onclick="addAuthAdmin()" style="width:100%; background: #fbbf24; color: black; font-weight: bold;">AUTHORIZE EMAIL</button>
                </div>

                <!-- MANAGE PASSCODES SECTION -->
                <div class="card" style="border-color: var(--primary);">
                    <h4>Security Manager</h4>
                    <p style="font-size:11px; color:var(--text-muted);">Set/Change Passcodes for ANY Role</p>
                    <select id="dev-role-select" class="modal-inp">
                        <option value="" disabled selected>Select Role to Update...</option>
                    </select>
                    <input id="new-role-pass" class="modal-inp" placeholder="New Passcode">
                    <button class="btn bg-blu" onclick="updateRolePass()" style="width:100%;">UPDATE PASSCODE</button>
                </div>

                <div class="card"><h4>Ban Admin</h4><input id="ban-admin-email" class="modal-inp" placeholder="Email"><button class="btn bg-red" onclick="banAdminByEmail()">BAN ADMIN</button></div>
            </div>
            
            <div class="table-wrapper">
                <div class="table-header">Authorized Emails</div>
                <div class="table-scroll"><table id="table-auth-admins"><thead><tr><th>Email</th><th>Assigned Role</th><th>Action</th></tr></thead><tbody id="auth-admin-list"></tbody></table></div>
            </div>

            <div class="table-wrapper"><div class="table-header">Banned Admins</div><div class="table-scroll"><table id="table-banned-admins"><thead><tr><th>Email</th><th>Action</th></tr></thead><tbody id="banned-admin-list"></tbody></table></div></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="info-modal" class="modal-overlay">
        <div class="modal-box" style="width: 100%; max-width:600px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3 style="margin:0;">Order Details</h3>
                <button class="btn bg-dark" onclick="document.getElementById('info-modal').style.display='none'"><i class="fas fa-times"></i></button>
            </div>
            <span class="info-label">Service Type</span><div class="info-val" id="inf-service" style="color:var(--primary); font-weight:bold;"></div>
            <span class="info-label">User Submitted Data</span><div class="info-val" id="inf-details" style="font-family:monospace;"></div>
            <span class="info-label">Attachments</span><div class="info-val" id="inf-file"></div>
            
            <div id="invoice-controls" style="display:none; border-top:1px solid #334155; margin-top:15px; padding-top:15px;">
                <h4 style="margin:0 0 10px; color:#c4b5fd;">Generate Invoice</h4>
                <div style="display:flex; gap:10px; align-items:flex-end;">
                    <div style="flex:1;">
                        <label class="info-label" style="margin-top:0;">Invoice Amount (Tk)</label>
                        <input id="manual-inv-price" type="number" class="modal-inp" placeholder="Enter amount" style="margin:0;">
                    </div>
                    <button class="btn bg-dark" onclick="downloadInvoice()" style="height:46px; border:1px solid #8b5cf6; color:#c4b5fd;">
                        <i class="fas fa-file-invoice"></i> Download PDF
                    </button>
                </div>
            </div>
            
            <button class="btn bg-blu" onclick="copyFullOrderInfo()" style="width:100%; margin-top:15px; justify-content:center; padding: 15px;"><i class="fas fa-copy"></i> Copy All Info</button>
        </div>
    </div>

    <!-- Other Modals -->
    <div id="service-modal" class="modal-overlay"><div class="modal-box"><h3>Service Details</h3><label class="info-label">Service Name</label><input id="svc-name" class="modal-inp"><label class="info-label">Service Name</label><input id="svc-name" class="modal-inp"><label class="info-label">Category</label><select id="svc-cat" class="modal-inp"></select><label class="info-label">Key</label><input id="svc-key" class="modal-inp"><label class="info-label">Price</label><input id="svc-price" type="number" class="modal-inp"><label class="info-label">Icon</label><input id="svc-icon" class="modal-inp"><button onclick="saveService()" class="btn bg-grn" style="width:100%; margin-top:15px;">SAVE SERVICE</button><button onclick="document.getElementById('service-modal').style.display='none'" class="btn bg-dark" style="width:100%; margin-top:5px;">Cancel</button></div></div>
    <div id="form-editor-modal" class="modal-overlay"><div class="modal-box" style="width: 100%; max-width:700px; height: 90vh; display:flex; flex-direction:column;"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;"><h3 style="margin:0;">Dynamic Form Builder</h3><button onclick="document.getElementById('form-editor-modal').style.display='none'" class="btn bg-red" style="padding:5px 10px;">✕</button></div><div style="margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:15px;"><label class="info-label">Select Service</label><select id="fe-service-select" class="modal-inp" onchange="loadServiceForm(this.value)"><option value="" disabled selected>Select a Service...</option></select></div><div id="fe-fields-container" style="flex:1; overflow-y:auto; padding-right:5px;"></div><div style="margin-top:15px; border-top:1px solid var(--border); padding-top:15px;"><button class="btn bg-blu" onclick="addFormRow()">+ Add Field</button><button class="btn bg-grn" onclick="saveFormConfig()" style="float:right;">Save Form</button></div></div></div>
    <div id="chat-modal" class="modal-overlay"><div class="modal-box" style="padding:0; width:100%; max-width:550px; height:85vh; display:flex; flex-direction:column; overflow:hidden;"><div style="padding:20px; background:var(--primary); display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:600; color:white;">Support Chat</span><button onclick="document.getElementById('chat-modal').style.display='none'" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;"><i class="fas fa-times"></i></button></div><div id="chat-msgs" style="flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:10px;"></div><div class="quick-replies-wrapper" id="qr-container"></div><button id="btn-manage-qr" onclick="openQrManager()" style="display:none; width:100%; background:var(--bg-card); color:var(--text-muted); border:none; padding:5px; font-size:10px; border-top:1px solid var(--border);">Manage Quick Replies</button><div style="padding:20px; border-top:1px solid var(--border); display:flex; gap:10px; background:var(--bg-card);"><input id="chat-in" class="modal-inp" style="margin:0;" placeholder="Type message..."><button onclick="sendRep()" class="btn bg-blu" style="width:50px; justify-content:center;"><i class="fas fa-paper-plane"></i></button></div></div></div>
    <div id="qr-manager-modal" class="modal-overlay"><div class="modal-box"><h3>Manage Quick Replies</h3><div style="display:flex; gap:10px; margin-bottom:15px;"><input id="new-qr-inp" class="modal-inp" placeholder="New Reply Text" style="margin:0;"><button onclick="addQr()" class="btn bg-grn">Add</button></div><div id="qr-list-edit" style="display:flex; flex-direction:column; gap:8px; max-height:300px; overflow-y:auto;"></div><button onclick="document.getElementById('qr-manager-modal').style.display='none'" class="btn bg-dark" style="width:100%; margin-top:15px;">Close</button></div></div>
    <div id="balance-modal" class="modal-overlay"><div class="modal-box"><h3>Update User Balance</h3><p>User: <span id="bal-edit-uname" style="color:var(--primary); font-weight:bold;"></span></p><input id="bal-edit-input" type="number" class="modal-inp" placeholder="Enter new balance"><button class="btn bg-grn" onclick="submitBalanceUpdate()" style="width:100%; margin-top:10px;">Update Balance</button><button class="btn bg-dark" onclick="document.getElementById('balance-modal').style.display='none'" style="width:100%; margin-top:5px;">Cancel</button></div></div>
    <div id="ban-modal" class="modal-overlay"><div class="modal-box"><h3 style="color:var(--danger)">Ban User</h3><select id="ban-reason-select" class="modal-inp" onchange="document.getElementById('ban-reason-input').value = this.value"><option value="" disabled selected>Select...</option><option value="Violation">Violation</option><option value="Spam">Spam</option></select><input id="ban-reason-input" class="modal-inp"><button class="btn bg-red" onclick="submitBan()" style="width:100%; margin-top:10px;">BAN</button><button class="btn bg-dark" onclick="document.getElementById('ban-modal').style.display='none'" style="width:100%; margin-top:5px;">Cancel</button></div></div>
    <div id="cancel-modal" class="modal-overlay"><div class="modal-box"><h3 style="color:var(--danger)">Cancel Order</h3><span id="cancel-info-txt" style="display:block; margin-bottom:10px;"></span><input id="cancel-reason" class="modal-inp" placeholder="Reason"><label class="check-group" style="margin: 10px 0; display:block;"><input type="checkbox" id="cancel-refund-check" style="margin-right:10px;"><span>Refund Cost?</span></label><button class="btn bg-red" onclick="submitCancel()" style="width:100%; margin-top:10px;">Confirm Cancel</button><button class="btn bg-dark" onclick="document.getElementById('cancel-modal').style.display='none'" style="width:100%; margin-top:5px;">Close</button></div></div>
    <div id="bal-reject-modal" class="modal-overlay"><div class="modal-box"><h3 style="color:var(--danger)">Reject</h3><span id="rej-info-txt" style="display:block; margin-bottom:10px;"></span><select id="rej-reason-select" class="modal-inp" onchange="document.getElementById('rej-reason-inp').value = this.value"><option value="" disabled selected>Quick Select...</option><option value="Invalid TRX">Invalid TRX</option><option value="Amount Mismatch">Amount Mismatch</option><option value="Duplicate Request">Duplicate</option></select><input id="rej-reason-inp" class="modal-inp" placeholder="Or type reason..."><button class="btn bg-red" onclick="submitBalReject()" style="width:100%; margin-top:10px;">Reject</button><button class="btn bg-dark" onclick="document.getElementById('bal-reject-modal').style.display='none'" style="width:100%; margin-top:5px;">Cancel</button></div></div>
    <div id="maint-modal" class="modal-overlay"><div class="modal-box"><h3>Maintenance Mode</h3><input id="maint-hours" type="number" class="modal-inp" placeholder="Timer (Hours)"><textarea id="maint-msg" class="modal-inp" placeholder="Custom Message"></textarea><button class="btn bg-blu" onclick="confirmMaint()" style="width:100%; margin-top:10px;">Start Maintenance</button><button class="btn bg-dark" onclick="document.getElementById('maint-modal').style.display='none'" style="width:100%; margin-top:5px;">Cancel</button></div></div>
    <div id="offline-modal" class="modal-overlay"><div class="modal-box"><h3 style="color:var(--danger)">System Offline</h3><textarea id="off-msg-inp" class="modal-inp" style="height:120px; font-size:12px;">বর্তমানে আমাদের সিস্টেমে নিরাপত্তা আপডেটের কাজ চলমান রয়েছে।...</textarea><button class="btn bg-red" onclick="confirmOffline()" style="width:100%; margin-top:10px;">Turn OFF System</button><button class="btn bg-dark" onclick="document.getElementById('offline-modal').style.display='none'" style="width:100%; margin-top:5px;">Cancel</button></div></div>
    <div id="bal-verify-modal" class="modal-overlay"><div class="modal-box"><h3>Verify</h3><p>User: <span id="v-uname"></span></p><p>TRX: <span id="v-trx"></span></p><p>Claim: <span id="v-claim"></span></p><input id="v-final-amount" type="number" class="modal-inp"><button onclick="submitBalApproval()" class="btn bg-grn" style="width:100%; margin-top:10px;">Approve</button><button onclick="document.getElementById('bal-verify-modal').style.display='none'" class="btn bg-dark" style="width:100%; margin-top:5px;">Cancel</button></div></div>
    <div id="proof-modal" class="modal-overlay" onclick="this.style.display='none'"><div class="modal-box" style="width:auto; max-width:90%; padding:15px; background:transparent; border:none;" onclick="event.stopPropagation()"><img id="proof-img-src" src="" class="proof-img"><div style="text-align:center; margin-top:15px;"><button class="btn bg-red" onclick="document.getElementById('proof-modal').style.display='none'">Close</button><a id="proof-link-src" href="" target="_blank" class="btn bg-blu">Full Size</a></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, inMemoryPersistence, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue, update, set, get, push, remove } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyB85E2DgcncPuUdY2TsiuULsXQJnzSo918", authDomain: "info-website-cb-24.firebaseapp.com", databaseURL: "https://info-website-cb-24-default-rtdb.firebaseio.com", projectId: "info-website-cb-24", storageBucket: "info-website-cb-24.firebasestorage.app", messagingSenderId: "625209481840", appId: "1:625209481840:web:534708ecc93ec66223b2b5" };
        const app = initializeApp(firebaseConfig, "AdminPanel");
        const auth = getAuth(app);
        
        setPersistence(auth, inMemoryPersistence); 

        const db = getDatabase(app);
        
        // --- DISABLE AUTO LOGIN (Force Logout on Refresh) ---
        signOut(auth).catch(e => console.log(e));
        sessionStorage.clear();

        // --- 7 FIXED ROLES DEFINED HERE ---
        const fixedRoles = ["HELIX PANEL", "Developer", "Moderator 1", "Moderator 2", "Moderator 3", "Moderator 4", "Moderator 5"];

        let DEV_MASTER_CODE = "dev_master"; const DEV_SURVEILLANCE_CODE = "dev_surveillance_on";
        const OFF_CODE = "258025", MAINT_PASS = "devloper001";
        
        let rolePasscodes = {};

        let currentAdminName = "Admin", activeChat = null, verifyKey = null, verifyUid = null, allOrdersData = {};
        let allDepositsData = {};
        let fakeSettings = { base: 0, auto: false };
        let realOrdersCount = 0, updateTimer = null;
        let globalServices = {}, globalServiceForms = {}, globalCategories = {}, quickReplies = [];
        let currentRejectBalKey = null, currentBanUserId = null, currentCancelOrderId = null, currentBalanceEditUid = null;
        let currentOrderInView = null; 
        let sessionTimer;
        const TIMEOUT_DURATION = 10 * 60 * 1000; 

        window.showToast = (msg, type = 'success') => { const box = document.getElementById('toast-box'); const el = document.createElement('div'); el.className = `toast ${type}`; el.innerHTML = `<span>${msg}</span>`; box.appendChild(el); setTimeout(() => el.remove(), 3500); };
        window.copyToClip = (text) => { const tempInput = document.createElement("textarea"); tempInput.value = text; document.body.appendChild(tempInput); tempInput.select(); document.execCommand("copy"); document.body.removeChild(tempInput); showToast("Copied to Clipboard!"); };
        window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('sidebar-overlay').classList.toggle('active'); };
        window.setView = (v,el) => { document.querySelectorAll('.view').forEach(x=>x.classList.remove('active')); document.getElementById(v).classList.add('active'); document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); el.classList.add('active'); if(window.innerWidth <= 768) window.toggleSidebar(); };

        function resetSessionTimer() { clearTimeout(sessionTimer); if(auth.currentUser) { sessionTimer = setTimeout(() => { alert("Session Timeout: You have been logged out due to inactivity."); window.logout(); }, TIMEOUT_DURATION); } }
        ['mousemove', 'mousedown', 'keypress', 'touchmove', 'click'].forEach(evt => { document.addEventListener(evt, resetSessionTimer); });

        // --- INTERNET CONNECTION CHECKER ---
        function checkNetworkStatus() {
            const overlay = document.getElementById('offline-warning-overlay');
            if(navigator.onLine) {
                overlay.style.display = 'none';
            } else {
                overlay.style.display = 'flex';
            }
        }
        window.addEventListener('online', checkNetworkStatus);
        window.addEventListener('offline', checkNetworkStatus);
        checkNetworkStatus();

        function updateAdminDisplay() {
            const label = document.getElementById('curr-adm-display');
            const isSuperOrDev = (currentAdminName === 'HELIX PANEL' || currentAdminName === 'Developer');
            if(label) { if(currentAdminName === 'Developer') { label.style.color = '#ec4899'; label.style.fontWeight = 'bold'; label.innerText = "DEVELOPER"; } else { label.style.color = 'var(--text-main)'; label.style.fontWeight = '600'; label.innerText = currentAdminName; } }
            const devNav = document.getElementById('dev-nav-item'); if(devNav) devNav.style.display = (currentAdminName === 'Developer') ? 'flex' : 'none';
            const navCat = document.getElementById('nav-categories'); if(navCat) navCat.style.display = isSuperOrDev ? 'flex' : 'none';
            const btnForms = document.getElementById('btn-forms'); if(btnForms) btnForms.style.display = isSuperOrDev ? 'inline-flex' : 'none';
            const btnAddSvc = document.getElementById('btn-add-service'); if(btnAddSvc) btnAddSvc.style.display = isSuperOrDev ? 'inline-flex' : 'none';
            const btnManageQr = document.getElementById('btn-manage-qr'); if(btnManageQr) btnManageQr.style.display = isSuperOrDev ? 'block' : 'none';
            const cardSuperTools = document.getElementById('card-super-tools'); if(cardSuperTools) cardSuperTools.style.display = isSuperOrDev ? 'block' : 'none';
            const cardAdminMap = document.getElementById('card-admin-map'); if(cardAdminMap) cardAdminMap.style.display = isSuperOrDev ? 'block' : 'none';
            renderServiceTable();
        }

        // --- LOGIN LOGIC ---
        window.admLog = async () => { 
            // Check Internet Connection
            if (!navigator.onLine) {
                showToast("No Internet Connection! Please connect to login.", "error");
                return;
            }

            const btn = document.getElementById('adm-login-btn'); 
            const e = document.getElementById('ae').value; 
            const p = document.getElementById('ap').value; 
            const pass = document.getElementById('adm-passcode').value; 
            const selectedRole = document.getElementById('adm-id').value;

            if(!selectedRole || !e || !p) return showToast("Enter all credentials", "error"); 
            
            btn.innerHTML = 'Verifying...'; btn.disabled = true; 
            try {
                const ipRes = await fetch('https://api.ipify.org?format=json'); const ipData = await ipRes.json(); const userIp = ipData.ip || "Unknown";
                
                const authSnap = await get(ref(db, 'settings/authorized_admins'));
                const authList = authSnap.val() || {};
                let isAuthorized = false;

                Object.values(authList).forEach(entry => {
                    if(entry.email === e && entry.role === selectedRole) {
                        isAuthorized = true;
                    }
                });
                
                const codeSnap = await get(ref(db, 'settings/security_codes'));
                const storedCodes = codeSnap.val() || {};
                
                let correctPass = storedCodes[selectedRole];
                
                if (!correctPass) {
                     if(selectedRole === 'HELIX PANEL') correctPass = "1234";
                     else if(selectedRole === 'Developer') correctPass = DEV_MASTER_CODE;
                     else throw new Error("No passcode set for this role! Contact Developer.");
                }

                if (!isAuthorized) {
                     if (pass !== correctPass) throw new Error("Wrong Passcode or Unauthorized Email!");
                } else {
                     if (pass !== correctPass) throw new Error("Wrong Passcode!");
                }

                const bannedList = (await get(ref(db, 'settings/banned_admins'))).val() || {}; 
                const isBanned = Object.values(bannedList).some(bannedEmail => bannedEmail === e); 
                if(isBanned) throw new Error("ACCESS DENIED: You are banned.");
                
                await setPersistence(auth, inMemoryPersistence); 
                await signInWithEmailAndPassword(auth, e, p); 
                await update(ref(db, 'settings/admin_map/' + selectedRole), { email: e, ip: userIp, last_login: Date.now() });
                
                currentAdminName = selectedRole; 
                sessionStorage.setItem('adminName', currentAdminName); 
                updateAdminDisplay(); 
                resetSessionTimer(); 
                showToast("Welcome back, " + currentAdminName); 

                if(currentAdminName === 'Developer') {
                     document.getElementById('dev-surveillance-overlay').style.display = 'none';
                }

            } catch(er) { 
                showToast(er.message, "error"); 
                btn.innerHTML = 'LOGIN DASHBOARD'; btn.disabled = false; 
            } 
        };
        
        onAuthStateChanged(auth, u => { if(u) { document.getElementById('login-overlay').style.display='none'; currentAdminName = sessionStorage.getItem('adminName') || "Admin"; updateAdminDisplay(); init(); resetSessionTimer(); } else { document.getElementById('login-overlay').style.display='flex'; togglePasscodeField(); clearTimeout(sessionTimer); } });
        window.logout = () => signOut(auth).then(()=>location.reload());

        function init() {
            // --- LOAD DYNAMIC ROLES ---
            onValue(ref(db, 'settings/admin_roles'), (s) => {
                const customRolesObj = s.val() || {};
                const customRoles = Object.values(customRolesObj);
                const uniqueRoles = new Set([...fixedRoles, ...customRoles]);

                const loginSelect = document.getElementById('adm-id');
                const devSelect = document.getElementById('dev-role-select');
                const authRoleSelect = document.getElementById('auth-admin-role'); 

                loginSelect.innerHTML = `<option value="" disabled selected>Select Role...</option>`;
                if(devSelect) devSelect.innerHTML = `<option value="" disabled selected>Select Role to Update...</option>`;
                if(authRoleSelect) authRoleSelect.innerHTML = `<option value="" disabled selected>Select Role...</option>`;

                uniqueRoles.forEach(role => {
                    let style = "";
                    if(role === 'Developer') style = "color:var(--danger); font-weight:bold;";
                    else if(role === 'HELIX PANEL') style = "color:var(--primary); font-weight:bold;";
                    
                    loginSelect.innerHTML += `<option value="${role}" style="${style}">${role}</option>`;
                    if(devSelect) devSelect.innerHTML += `<option value="${role}">${role}</option>`;
                    if(authRoleSelect) authRoleSelect.innerHTML += `<option value="${role}">${role}</option>`;
                });
            });

            // --- LOAD SECURITY CODES ---
            onValue(ref(db, 'settings/security_codes'), (s) => {
                rolePasscodes = s.val() || {};
                DEV_MASTER_CODE = rolePasscodes['Developer'] || "dev_master";
            });

            // --- SURVEILLANCE LOGIC ---
            onValue(ref(db, 'settings/dev_surveillance'), (s) => { 
                const isLocked = s.val() === true; 
                const overlay = document.getElementById('dev-surveillance-overlay'); 
                const statusText = document.getElementById('dev-status-text'); 
                const btnStart = document.getElementById('btn-dev-start'); 
                const btnStop = document.getElementById('btn-dev-stop'); 
                
                if(statusText) { 
                    statusText.innerText = isLocked ? "ACTIVE (Admins Locked)" : "Inactive"; 
                    statusText.style.color = isLocked ? "#10b981" : "#94a3b8"; 
                } 
                if(btnStart && btnStop) { 
                    if(isLocked) { btnStart.style.display = 'none'; btnStop.style.display = 'block'; } 
                    else { btnStart.style.display = 'block'; btnStop.style.display = 'none'; } 
                } 
                
                if (isLocked && currentAdminName !== 'Developer') { 
                    overlay.style.display = 'flex'; 
                } else { 
                    overlay.style.display = 'none'; 
                } 
            });

            onValue(ref(db, 'settings/admin_map'), (s) => { const tbody = document.getElementById('admin-map-body'); if(!tbody) return; tbody.innerHTML = ""; const data = s.val(); if(data) { Object.entries(data).forEach(([role, info]) => { const dateStr = info.last_login ? new Date(info.last_login).toLocaleString() : 'N/A'; tbody.innerHTML += `<tr><td style="padding:10px; font-weight:600; color:white;">${role}</td><td style="padding:10px; font-family:monospace; color:#94a3b8;">${info.email}</td><td style="padding:10px; font-family:monospace; color:#ef4444;">${info.ip || 'Unknown'}</td><td style="padding:10px; font-size:12px; color:#64748b;">${dateStr}</td></tr>`; }); } else { tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:10px;">No active logins recorded yet.</td></tr>`; } });
            
            // --- LOAD AUTHORIZED ADMINS LIST ---
            onValue(ref(db, 'settings/authorized_admins'), s => {
                const l = document.getElementById('auth-admin-list');
                if(!l) return;
                l.innerHTML = "";
                const data = s.val();
                if(data) {
                    Object.entries(data).forEach(([key, entry]) => {
                        l.innerHTML += `<tr><td>${entry.email}</td><td><span class="badge badge-proc">${entry.role}</span></td><td><button class="btn bg-red" onclick="window.removeAuthAdmin('${key}')" style="padding: 5px 10px; font-size: 12px;">Remove</button></td></tr>`;
                    });
                } else {
                    l.innerHTML = `<tr><td colspan="3" style="text-align:center; color:#64748b; padding:10px;">No authorized emails yet.</td></tr>`;
                }
            });

            onValue(ref(db, 'settings/banned_admins'), s => { const l = document.getElementById('banned-admin-list'); if(!l) return; l.innerHTML = ""; const data = s.val(); if(data) { Object.entries(data).forEach(([key, email]) => { l.innerHTML += `<tr><td style="color: white;">${email}</td><td><button class="btn bg-red" onclick="window.unbanAdmin('${key}')" style="padding: 5px 10px; font-size: 12px;">Unban</button></td></tr>`; }); } });
            onValue(ref(db, 'settings/quick_replies'), s => { quickReplies = s.val() || []; renderQuickReplies(); });
            onValue(ref(db, 'settings/categories'), s => { globalCategories = s.val() || {}; renderCategoryTable(); });
            onValue(ref(db, 'settings/services_list'), s => { globalServices = s.val() || {}; renderServiceTable(); });
            onValue(ref(db, 'settings/service_forms'), s => { globalServiceForms = s.val() || {}; });
            onValue(ref(db, 'settings'), (s) => { const data = s.val() || { system_status: 'active' }; document.querySelectorAll('.ctrl-btn').forEach(btn => btn.classList.remove('active-on', 'active-maint', 'active-off')); if(data.system_status === 'active') { if(document.getElementById('btn-active')) document.getElementById('btn-active').classList.add('active-on'); } else if(data.system_status === 'maintenance') { if(document.getElementById('btn-maint')) document.getElementById('btn-maint').classList.add('active-maint'); } else { if(document.getElementById('btn-off')) document.getElementById('btn-off').classList.add('active-off'); } if(data.fake_counter) { fakeSettings = data.fake_counter; document.getElementById('fake-inp').value = fakeSettings.base || 0; calcDisplayTotal(); } if(data.announcement) document.getElementById('announce-inp').value = data.announcement; if(data.popup_notice) { document.getElementById('popup-text').value = data.popup_notice.text || ""; const popupBadge = document.getElementById('popup-badge'); if(data.popup_notice.active) { popupBadge.innerText = "Active"; popupBadge.className = "badge badge-success"; } else { popupBadge.innerText = "Hidden"; popupBadge.className = "badge badge-danger"; } } });
            onValue(ref(db, 'orders'), (s) => { const l = document.getElementById('ord-list'); const logL = document.getElementById('log-list'); l.innerHTML=""; logL.innerHTML=""; let pen=0; realOrdersCount = 0; let todayRealOrders = 0; const todayStr = new Date().toDateString(); allOrdersData = {}; const data = s.val(); const serviceSet = new Set(); const filterSvcSelect = document.getElementById('filter-service'); if(data) { Object.entries(data).reverse().forEach(([key, o]) => { allOrdersData[key] = o; realOrdersCount++; if(o.service) serviceSet.add(o.service); if(o.timestamp && new Date(o.timestamp).toDateString() === todayStr) { todayRealOrders++; } if(o.status==='pending') pen++; let badge = o.status==='pending' ? 'badge-pending' : (o.status==='processing'?'badge-proc':(o.status==='completed'?'badge-success':'badge-danger')); let actions = ""; if(o.status==='pending') actions = `<button class="btn bg-blu" onclick="window.proc('${key}')"><i class="fas fa-play"></i></button> <button class="btn bg-red" onclick="window.openCancelModal('${key}')"><i class="fas fa-times"></i></button>`; else if(o.status==='processing') actions = `<button class="btn bg-grn" onclick="window.comp('${key}','${o.userId}')"><i class="fas fa-check"></i></button>`; l.innerHTML += `<tr><td>#${o.orderId_visible || 'N/A'}</td><td><b>${o.uName || 'Unknown'}</b></td><td>${o.service || 'Unknown'}</td><td><span class="badge ${badge}">${o.status}</span></td><td>${new Date(o.timestamp).toLocaleDateString()}</td><td style="text-align:center;"><div style="display:flex; gap:5px; justify-content:center;"><button class="btn bg-dark" onclick="window.showInfo('${key}')"><i class="fas fa-eye"></i></button> <button class="btn bg-blu" onclick="window.chat('${key}')"><i class="fas fa-comment-dots"></i></button> ${actions}</div></td></tr>`; if(o.handledBy) { let logAction = o.status === 'completed' ? 'Completed Order' : 'Updated Status'; let logTime = new Date(o.completed_at || o.timestamp).toLocaleString(); logL.innerHTML += `<tr><td>#${o.orderId_visible}</td><td>${logAction}</td><td><span class="badge badge-success">${o.handledBy}</span></td><td>${logTime}</td></tr>`; } }); let currentSvcVal = filterSvcSelect.value; filterSvcSelect.innerHTML = '<option value="all">All Services</option>'; serviceSet.forEach(svc => { filterSvcSelect.innerHTML += `<option value="${svc}">${svc}</option>`; }); filterSvcSelect.value = currentSvcVal; } document.getElementById('c-pen').innerText = pen; document.getElementById('nav-ord-count').innerText = pen; document.getElementById('nav-ord-count').style.display = pen>0?'inline-block':'none'; document.getElementById('c-total-real').innerText = realOrdersCount; document.getElementById('c-today-real').innerText = todayRealOrders; calcDisplayTotal(); window.globalSearch(); });
            if(updateTimer) clearInterval(updateTimer); updateTimer = setInterval(calcDisplayTotal, 1000 * 30);
            
            onValue(ref(db, 'balance_requests'), (s) => { 
                const l=document.getElementById('bal-list'); l.innerHTML=""; 
                let pendingReq=0, pendingAmt=0; 
                allDepositsData = {};
                const data = s.val(); 
                if(data) { 
                    Object.entries(data).reverse().forEach(([key, b]) => { 
                        allDepositsData[key] = b;
                        if(b.status==='pending') { pendingReq++; pendingAmt += Number(b.amount||0); } 
                        let proofBtn = b.screenshot ? `<button class="btn bg-dark" onclick="viewProof('${b.screenshot}')">Proof</button>` : 'No Img'; 
                        let actions = "";
                        if(b.status==='pending') {
                            actions = `<div style="display:flex; gap:5px; justify-content:center;"><button class="btn bg-grn" onclick="verifyBal('${key}','${b.uid}',${b.amount},'${b.uName}','${b.trxId}')"><i class="fas fa-check"></i></button><button class="btn bg-red" onclick="openRejectModal('${key}', '${b.uName}', '${b.trxId}')"><i class="fas fa-times"></i></button></div>`;
                        } else {
                            let downloadBtn = b.status === 'approved' ? `<button class="btn bg-dark" style="margin-left:5px; padding:4px 8px; font-size:12px;" onclick="downloadDepositInvoice('${key}')" title="Download Receipt"><i class="fas fa-file-invoice"></i></button>` : '';
                            actions = `<div style="display:flex; justify-content:center; align-items:center;"><span class="badge ${b.status==='approved'?'badge-success':'badge-danger'}">${b.status}</span>${downloadBtn}</div>`;
                        }
                        l.innerHTML += `<tr><td><b>${b.uName || 'Unknown'}</b><br><small style="color:orange">${b.accMobile||''}</small></td><td>${b.trxId}</td><td style="color:var(--success);font-weight:bold">৳${b.amount}</td><td>${proofBtn}</td><td><span class="badge ${b.status==='pending'?'badge-pending':(b.status==='approved'?'badge-success':'badge-danger')}">${b.status}</span></td><td>${actions}</td></tr>`; 
                    }); 
                } 
                document.getElementById('c-pen-money').innerText = "৳ "+pendingAmt; 
                document.getElementById('nav-bal-count').innerText = pendingReq; 
                document.getElementById('nav-bal-count').style.display = pendingReq>0?'inline-block':'none'; 
                window.globalSearch();
            });

            // --- UPDATED USERS TAB LOGIC ---
            onValue(ref(db, 'users'), (s) => { 
                const l=document.getElementById('usr-list'); l.innerHTML=""; let uc=0; let pendingUsers = 0;
                const data = s.val(); 
                if(data) { 
                    Object.entries(data).forEach(([key, u]) => { 
                        if(u.role !== 'admin'){ 
                            uc++; 
                            if(u.status === 'pending') pendingUsers++;
                            let action = ""; 
                            let statusBadge = `<span class="badge badge-success">${u.status || 'Active'}</span>`; 
                            if (u.status === 'pending') statusBadge = `<span class="badge badge-pending">Pending</span>`; 
                            else if (u.status === 'banned') statusBadge = `<span class="badge badge-danger">Banned</span>`; 
                            else if (u.status === 'rejected') statusBadge = `<span class="badge badge-danger">Rejected</span>`; 
                            
                            if (u.status === 'pending') { action = `<button class="btn bg-grn" onclick="modUser('${key}','active')">Approve</button><button class="btn bg-red" onclick="modUser('${key}','rejected')">Reject</button>`; } 
                            else if (u.status === 'banned') { action = `<button class="btn bg-blu" onclick="modUser('${key}','active')">Unban</button>`; } 
                            else if (u.status === 'rejected') { action = `<button class="btn bg-blu" onclick="modUser('${key}','active')">Re-Approve</button>`; } 
                            else { action = `<button class="btn bg-red" onclick="openBanModal('${key}')">Ban</button>`; } 
                            
                            // Reset Password Button (Visible ONLY to Developer)
                            let resetBtn = "";
                            if(currentAdminName === 'Developer') {
                                resetBtn = `<button class="btn bg-dark" onclick="sendUserPassReset('${u.email}')" title="Send Password Reset Email" style="margin-left:5px;"><i class="fas fa-key" style="color:var(--warning)"></i></button>`;
                            }
                            
                            let verifyBtn = u.isVerified ? `<button class="btn bg-dark" onclick="toggleVerify('${key}', false)" title="Remove Badge"><i class="fas fa-times-circle" style="color:var(--danger)"></i></button>` : `<button class="btn bg-dark" onclick="toggleVerify('${key}', true)" title="Add Badge"><i class="fas fa-check-circle" style="color:var(--success)"></i></button>`; 
                            let tgLink = u.telegram ? `<a href="https://t.me/${u.telegram.replace('@','')}" target="_blank" style="color:#3b82f6; text-decoration:none;">${u.telegram}</a>` : '<span style="color:#64748b;">N/A</span>'; 
                            
                            l.innerHTML+=`<tr><td>${u.name} ${resetBtn}</td><td>${u.phone}</td><td>${tgLink}</td><td>${u.email}</td><td style="color:var(--success)">৳${u.balance||0} <button class="btn bg-dark" style="padding:2px 6px; font-size:10px; margin-left:5px;" onclick="openBalanceModal('${key}', '${u.name}', ${u.balance||0})"><i class="fas fa-edit"></i></button></td><td>${statusBadge}</td><td style="text-align:center; display:flex; gap:5px; justify-content:center;">${action}${verifyBtn}</td></tr>`; 
                        } 
                    }); 
                } 
                document.getElementById('c-usr').innerText=uc; 
                const navUsrCount = document.getElementById('nav-usr-count'); if(navUsrCount) { navUsrCount.innerText = pendingUsers; navUsrCount.style.display = pendingUsers > 0 ? 'inline-block' : 'none'; }
                window.globalSearch();
            });
        }

        // --- NEW PASSWORD RESET FUNCTION (SECURED) ---
        window.sendUserPassReset = (email) => {
            // Security Check
            if (currentAdminName !== 'Developer') {
                return showToast("Only Developer can reset passwords!", "error");
            }

            if(!email) return showToast("User has no email!", "error");
            
            if(confirm(`Send Password Reset Link to: ${email}?`)) {
                sendPasswordResetEmail(auth, email)
                .then(() => showToast("Reset Link Sent!"))
                .catch((e) => showToast(e.message, "error"));
            }
        };

        window.addNewRole = () => {
            const roleName = document.getElementById('new-role-name').value.trim();
            if(!roleName) return showToast("Role Name Required", "error");
            push(ref(db, 'settings/admin_roles'), roleName).then(() => {
                showToast(`Role '${roleName}' Added! Set Passcode Now.`);
                document.getElementById('new-role-name').value = "";
            });
        };

        window.addAuthAdmin = () => {
            const email = document.getElementById('auth-admin-email').value.trim();
            const role = document.getElementById('auth-admin-role').value;
            if(!email || !role) return showToast("Email and Role Required", "error");
            
            push(ref(db, 'settings/authorized_admins'), { email: email, role: role }).then(() => {
                showToast(`Authorized: ${email} as ${role}`);
                document.getElementById('auth-admin-email').value = "";
            });
        };

        window.removeAuthAdmin = (key) => {
            if(confirm("Remove this email from authorized list?")) {
                remove(ref(db, `settings/authorized_admins/${key}`)).then(() => showToast("Removed from whitelist"));
            }
        };

        window.updateRolePass = () => {
            const role = document.getElementById('dev-role-select').value;
            const pass = document.getElementById('new-role-pass').value.trim();
            if(!role || !pass) return showToast("Select Role & Enter Passcode", "error");

            update(ref(db, 'settings/security_codes'), { [role]: pass }).then(() => {
                showToast(`Passcode Updated for ${role}`);
                document.getElementById('new-role-pass').value = "";
            });
        };
        
        // --- NEW UNIVERSAL SEARCH FUNCTION ---
        window.globalSearch = () => {
            const input = document.getElementById("global-search");
            const filter = input.value.toUpperCase();
            
            // 1. Determine which view is active
            const activeView = document.querySelector('.view.active');
            if(!activeView) return;

            // 2. Find ANY table inside the active view
            const table = activeView.querySelector('table');
            if (!table) return; // e.g. Dashboard has no table

            const tr = table.getElementsByTagName("tr");
            
            // Special Logic for Orders Tab (Dropdown Filters)
            const isOrderTab = (activeView.id === 'orders');
            const statusFilter = isOrderTab ? document.getElementById('filter-status').value : 'all';
            const serviceFilter = isOrderTab ? document.getElementById('filter-service').value : 'all';

            // 3. Loop through rows (skip header)
            for (let i = 1; i < tr.length; i++) {
                let textMatch = false;
                const tdArr = tr[i].getElementsByTagName("td");
                
                // Check if ANY cell contains search text
                for(let j=0; j<tdArr.length; j++) {
                    if(tdArr[j] && tdArr[j].textContent.toUpperCase().indexOf(filter) > -1) {
                        textMatch = true;
                        break;
                    }
                }

                if(isOrderTab) {
                    // Orders need to check Dropdowns + Text
                    const statusSpan = tr[i].querySelector('.badge');
                    const statusText = statusSpan ? statusSpan.innerText.toLowerCase() : "";
                    const serviceText = tdArr[2] ? tdArr[2].innerText : "";
                    
                    const matchStatus = (statusFilter === 'all' || statusText === statusFilter);
                    const matchService = (serviceFilter === 'all' || serviceText === serviceFilter);

                    if(textMatch && matchStatus && matchService) tr[i].style.display = "";
                    else tr[i].style.display = "none";
                } else {
                    // Generic Search for Users, Services, Logs, etc.
                    if(textMatch) tr[i].style.display = "";
                    else tr[i].style.display = "none";
                }
            }
        };

        // --- EXISTING FUNCTIONS ---
        window.updateSecurityCodes = () => { const adminCode = document.getElementById('new-admin-pass').value; const devCode = document.getElementById('new-dev-pass').value; if(!adminCode && !devCode) return showToast("Enter at least one new code", "error"); const updates = {}; if(adminCode) updates.admin = adminCode; if(devCode) updates.dev = devCode; update(ref(db, 'settings/security_codes'), updates).then(() => { showToast("Security Codes Updated!"); document.getElementById('new-admin-pass').value = ""; document.getElementById('new-dev-pass').value = ""; }).catch(err => showToast(err.message, "error")); };
        window.backupDB = async () => { if(!confirm("Download full database backup?")) return; try { showToast("Preparing backup..."); const snap = await get(ref(db, '/')); const data = snap.val(); const json = JSON.stringify(data, null, 2); const blob = new Blob([json], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `backup_silent_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); showToast("Download started!"); } catch(e) { showToast("Backup failed: " + e.message, "error"); } };
        window.sendGlobalAlert = () => { const msg = document.getElementById('global-alert-text').value.trim(); if(!msg) return showToast("Enter alert message", "error"); update(ref(db, 'settings/global_alert'), { message: msg, timestamp: Date.now(), active: true }).then(() => { showToast("Global Alert Sent!"); document.getElementById('global-alert-text').value = ""; }); };
        window.toggleSurveillance = (turnOn) => { const code = document.getElementById('dev-code-inp').value; if(turnOn) { if(code === DEV_SURVEILLANCE_CODE) { update(ref(db, 'settings'), { dev_surveillance: true }); showToast("Surveillance Mode ACTIVATED"); document.getElementById('dev-code-inp').value = ""; } else { showToast("Wrong Code!", "error"); } } else { update(ref(db, 'settings'), { dev_surveillance: false }); showToast("Surveillance Mode DEACTIVATED"); } };
        window.banAdminByEmail = () => { const email = document.getElementById('ban-admin-email').value.trim(); if(!email) return showToast("Enter email", "error"); push(ref(db, 'settings/banned_admins'), email).then(() => { showToast("Admin Banned: " + email); document.getElementById('ban-admin-email').value = ""; }); };
        window.unbanAdmin = (key) => { if(confirm("Unban this admin?")) { remove(ref(db, `settings/banned_admins/${key}`)).then(() => showToast("Admin Unbanned")).catch(err => showToast(err.message, "error")); } };
        window.openQrManager = () => { document.getElementById('qr-manager-modal').style.display = 'flex'; renderQrEditList(); };
        function renderQuickReplies() { const container = document.getElementById('qr-container'); container.innerHTML = ""; quickReplies.forEach((text, index) => { if(text) { const chip = document.createElement('div'); chip.className = 'qr-chip'; chip.innerText = text; chip.onclick = () => sendRep(text); container.appendChild(chip); } }); }
        window.addQr = () => { const text = document.getElementById('new-qr-inp').value.trim(); if(!text) return; const newReplies = [...quickReplies, text]; update(ref(db, 'settings'), { quick_replies: newReplies }).then(()=>{ document.getElementById('new-qr-inp').value = ""; showToast("Reply Added!"); }); };
        window.removeQr = (idx) => { if(!confirm("Delete this reply?")) return; const newReplies = quickReplies.filter((_, i) => i !== idx); update(ref(db, 'settings'), { quick_replies: newReplies }); };
        function renderQrEditList() { const list = document.getElementById('qr-list-edit'); list.innerHTML = ""; quickReplies.forEach((text, index) => { if(text) { list.innerHTML += `<div style="background:rgba(255,255,255,0.05); padding:8px; border-radius:6px; display:flex; justify-content:space-between; align-items:center;"><span style="font-size:12px;">${text}</span><button class="btn bg-red" style="padding:2px 6px; font-size:10px;" onclick="removeQr(${index})"><i class="fas fa-trash"></i></button></div>`; } }); }
        window.renderCategoryTable = () => { const tbody = document.getElementById('cat-list-body'); const svcSelect = document.getElementById('svc-cat'); tbody.innerHTML = ""; svcSelect.innerHTML = "<option value='Others'>Others</option>"; Object.entries(globalCategories).forEach(([key, name]) => { tbody.innerHTML += `<tr><td>${name}</td><td style="text-align:right;"><button class="btn bg-dark" onclick="editCategory('${key}', '${name.replace(/'/g, "\\'")}')"><i class="fas fa-edit"></i></button><button class="btn bg-red" onclick="delCategory('${key}')"><i class="fas fa-trash"></i></button></td></tr>`; svcSelect.innerHTML += `<option value="${name}">${name}</option>`; }); };
        window.renderServiceTable = () => { const l = document.getElementById('svc-list'); l.innerHTML = ""; const sel = document.getElementById('fe-service-select'); sel.innerHTML = '<option value="" disabled selected>Select Service...</option>'; const isSuperOrDev = (currentAdminName === 'HELIX PANEL' || currentAdminName === 'Developer'); const thStatus = document.getElementById('th-status'); const thActions = document.getElementById('th-actions'); if(thStatus) thStatus.style.display = isSuperOrDev ? '' : 'none'; if(thActions) thActions.style.display = isSuperOrDev ? '' : 'none'; Object.entries(globalServices).forEach(([key, svc]) => { const checked = svc.active !== false ? 'checked' : ''; let statusToggle = isSuperOrDev ? `<label class="switch"><input type="checkbox" ${checked} onchange="toggleSvc('${key}', this.checked)"><span class="slider"></span></label>` : ''; let actionButtons = isSuperOrDev ? `<div style="display:flex;gap:5px;"><button class="btn bg-dark" onclick="openServiceModal('${key}')"><i class="fas fa-edit"></i></button><button class="btn bg-red" onclick="delSvc('${key}')"><i class="fas fa-trash"></i></button></div>` : ''; let row = `<tr><td><i class="${svc.icon}"></i></td><td>${svc.name}</td><td>${svc.category || 'Others'}</td><td><small>${key}</small></td><td>৳${svc.price}</td>`; if(isSuperOrDev) { row += `<td>${statusToggle}</td><td>${actionButtons}</td>`; } row += `</tr>`; l.innerHTML += row; sel.innerHTML += `<option value="${key}">${svc.name}</option>`; }); };
        window.addCategory = () => { const name = document.getElementById('new-cat-inp').value.trim(); if(!name) return showToast("Enter category name", "error"); const key = name.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, ''); update(ref(db, 'settings/categories'), { [key]: name }).then(() => { showToast("Category Added!"); document.getElementById('new-cat-inp').value = ""; }); };
        window.editCategory = (key, oldName) => { const newName = prompt("Enter new category name:", oldName); if(newName && newName.trim() !== "") { update(ref(db, 'settings/categories'), { [key]: newName.trim() }).then(() => showToast("Category Updated!")); } };
        window.delCategory = (key) => { if(confirm("Delete this category?")) { remove(ref(db, 'settings/categories/' + key)).then(() => showToast("Category Deleted")); } };
        window.saveAnnouncement = () => { update(ref(db, 'settings'), { announcement: document.getElementById('announce-inp').value }).then(() => showToast("Announcement Updated!")); };
        window.setPopup = (status) => { const txt = document.getElementById('popup-text').value; if(status && !txt) return showToast("Enter popup text first!", "error"); update(ref(db, 'settings/popup_notice'), { text: txt, active: status }).then(() => { showToast(status ? "Popup Activated!" : "Popup Hidden", status ? 'success' : 'error'); }); };
        window.openServiceModal = (key = null) => { const svcSelect = document.getElementById('svc-cat'); svcSelect.innerHTML = "<option value='Others'>Others</option>"; Object.entries(globalCategories).forEach(([k, name]) => { svcSelect.innerHTML += `<option value="${name}">${name}</option>`; }); if(key) { const s = globalServices[key]; document.getElementById('svc-name').value = s.name; document.getElementById('svc-key').value = key; document.getElementById('svc-key').disabled = true; document.getElementById('svc-price').value = s.price; document.getElementById('svc-icon').value = s.icon; document.getElementById('svc-cat').value = s.category || "Others"; } else { document.getElementById('svc-name').value = ""; document.getElementById('svc-key').value = ""; document.getElementById('svc-key').disabled = false; document.getElementById('svc-price').value = ""; document.getElementById('svc-icon').value = "fas fa-star"; document.getElementById('svc-cat').value = "Others"; } document.getElementById('service-modal').style.display = 'flex'; };
        window.saveService = () => { const k = document.getElementById('svc-key').value.trim(), n = document.getElementById('svc-name').value, p = document.getElementById('svc-price').value, i = document.getElementById('svc-icon').value, c = document.getElementById('svc-cat').value; if(!k || !n || !p) return showToast("Fill all fields", "error"); update(ref(db, 'settings/services_list/' + k), { name: n, price: parseInt(p), icon: i, category: c, active: true }).then(() => { showToast("Service Saved!"); document.getElementById('service-modal').style.display = 'none'; }); };
        window.toggleSvc = (k, s) => update(ref(db, `settings/services_list/${k}`), { active: s });
        window.delSvc = (k) => { if(confirm("Delete service?")) remove(ref(db, `settings/services_list/${k}`)); };
        window.openFormEditor = () => document.getElementById('form-editor-modal').style.display = 'flex';
        window.loadServiceForm = (k) => { onValue(ref(db, `settings/service_forms/${k}`), s => { const fields = s.val() || []; const c = document.getElementById('fe-fields-container'); c.innerHTML = ""; if(fields.length === 0) addFormRow(); else fields.forEach(f => addFormRow(f)); }, {onlyOnce: true}); };
        window.addFormRow = (d=null) => { const c = document.getElementById('fe-fields-container'); const div = document.createElement('div'); div.innerHTML = `<div style="display:flex; gap:10px; margin-bottom:10px; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; align-items:center; flex-wrap:wrap;"><div style="flex:2; min-width:120px;"><input class="modal-inp fe-label" style="margin:0; padding:8px;" placeholder="Label Name"></div><div style="flex:1; min-width:100px;"><select class="modal-inp fe-type" style="margin:0; padding:8px;" onchange="toggleOpt(this)"><option value="text">Text (Small)</option><option value="textarea">Large Text</option><option value="number">Number</option><option value="link">Link (URL)</option><option value="file_url">Image (Upload Link)</option><option value="radio_grid">Button Grid</option></select></div><div class="fe-opt-div" style="flex:2; display:none; min-width:100%;"><input class="modal-inp fe-options" style="margin:0; padding:8px;" placeholder="Option1=20, Option2"></div><button class="btn bg-red" onclick="this.parentElement.parentElement.remove()" style="padding:0 10px; height:36px;">✕</button></div>`; const row = div.firstElementChild, labelInp = row.querySelector('.fe-label'), typeSel = row.querySelector('.fe-type'), optInp = row.querySelector('.fe-options'), optDiv = row.querySelector('.fe-opt-div'); if(d) { labelInp.value = d.label || ''; typeSel.value = d.type || 'text'; optInp.value = d.options || ''; if(d.type === 'radio_grid') optDiv.style.display = 'block'; } c.appendChild(div); };
        window.toggleOpt = (el) => { const row = el.closest('div[style*="display:flex"]'); row.querySelector('.fe-opt-div').style.display = (el.value === 'radio_grid') ? 'block' : 'none'; };
        window.saveFormConfig = () => { const k = document.getElementById('fe-service-select').value; if(!k) return showToast("Select Service first", "error"); const rows = document.querySelectorAll('#fe-fields-container > div'); const data = []; rows.forEach(r => { const l = r.querySelector('.fe-label').value; const t = r.querySelector('.fe-type').value; if(l) { let obj = { label: l, type: t }; if(t === 'radio_grid') obj.options = r.querySelector('.fe-options').value; data.push(obj); } }); set(ref(db, `settings/service_forms/${k}`), data).then(()=>showToast("Form Saved!")); };
        window.calcDisplayTotal = () => { let total = realOrdersCount + (parseInt(fakeSettings.base) || 0); if(fakeSettings.auto && fakeSettings.start_ts) { const now = Date.now(); const mins = (now - fakeSettings.start_ts) / (1000 * 60); total += Math.floor(mins); } document.getElementById('fake-display').innerText = total.toLocaleString(); };
        window.updateFakeCount = () => { const val = parseInt(document.getElementById('fake-inp').value); if(!val && val !== 0) return showToast("Enter a number", "error"); update(ref(db, 'settings/fake_counter'), { base: val }); showToast("Base Count Updated!"); };
        window.toggleFakeAuto = () => { const isRunning = fakeSettings.auto; if (isRunning) { const now = Date.now(); const start = fakeSettings.start_ts || now; const minutesAdded = Math.floor((now - start) / (1000 * 60)); const currentBase = parseInt(fakeSettings.base) || 0; const newBase = currentBase + minutesAdded; update(ref(db, 'settings/fake_counter'), { auto: false, base: newBase, start_ts: null }); document.getElementById('fake-inp').value = newBase; showToast(`Stopped & Saved at: ${newBase}`); } else { update(ref(db, 'settings/fake_counter'), { auto: true, start_ts: Date.now() }); showToast("Auto Counter Started"); } };
        window.changeSystemStatus = (status) => { if(status === 'active') { if(confirm("Switch System to ONLINE?")) { update(ref(db, 'settings'), { system_status: 'active' }); showToast("System is now ONLINE"); } } else if(status === 'off') { if(prompt("Enter Code:") === OFF_CODE) { document.getElementById('offline-modal').style.display = 'flex'; } else { showToast("Wrong Code!", "error"); } } };
        window.openMaintModal = () => { if(prompt("Password:") === MAINT_PASS) { document.getElementById('maint-modal').style.display = 'flex'; } else { showToast("Wrong Password!", "error"); } };
        window.confirmMaint = () => { const hours = document.getElementById('maint-hours').value; const msg = document.getElementById('maint-msg').value; if (!hours && !msg) return showToast("Enter Time or Message", "error"); let d = { system_status: 'maintenance', maint_message: msg.trim() }; if (hours && !isNaN(hours) && hours.trim() !== "") { d.maint_type = 'timer'; d.maint_end_ts = Date.now() + (parseFloat(hours)*3600000); } else { d.maint_end_ts = null; } update(ref(db, 'settings'), d); document.getElementById('maint-modal').style.display='none'; showToast("Maintenance Started", "warning"); };
        window.confirmOffline = () => { const msg = document.getElementById('off-msg-inp').value.trim(); const defaultMsg = "System Offline..."; const finalMsg = msg || defaultMsg; update(ref(db, 'settings'), { system_status: 'off', off_message: finalMsg }).then(() => { document.getElementById('offline-modal').style.display = 'none'; showToast("System Turned OFF", "error"); }); };
        
        // --- INVOICE GENERATOR ---
        window.showInfo = (k) => { 
            const d = allOrdersData[k]; 
            currentOrderInView = d; 
            
            if(d) { 
                document.getElementById('inf-service').innerText = d.service; 
                document.getElementById('inf-details').innerHTML = (d.details || "").replace(/\n/g, "<br>"); 
                document.getElementById('inf-file').innerHTML = d.file ? `<a href="${d.file}" target="_blank" class="btn bg-blu">Open Link</a>` : "None"; 
                
                const invoiceControls = document.getElementById('invoice-controls');
                const manualPriceInput = document.getElementById('manual-inv-price');

                if (d.status === 'completed') {
                    invoiceControls.style.display = 'block'; 
                    let dbPrice = d.cost || d.price || d.amount || "";
                    manualPriceInput.value = dbPrice;
                } else {
                    invoiceControls.style.display = 'none'; 
                }

                document.getElementById('info-modal').style.display = 'flex'; 
            } 
        };

        window.downloadInvoice = () => {
            if(!currentOrderInView) return showToast("Order data missing!", "error");
            
            showToast("Generating PDF...");
            const o = currentOrderInView;
            const { jsPDF } = window.jspdf;

            var manualVal = document.getElementById('manual-inv-price').value;
            var finalAmt = 0;
            if(manualVal && manualVal.trim() !== "") finalAmt = parseFloat(manualVal);
            else if (o.cost) finalAmt = parseFloat(o.cost);
            else if (o.price) finalAmt = parseFloat(o.price);
            else if (o.amount) finalAmt = parseFloat(o.amount);
            
            const formattedPrice = "Tk " + finalAmt.toFixed(2);
            const dateStr = new Date(o.timestamp).toLocaleDateString();
            const orderId = "#" + (o.orderId_visible || o.orderId);
            const userName = o.uName || "Guest User";
            const uidShort = o.userId ? o.userId.substring(0,8)+"..." : "N/A";
            const serviceName = o.service || "Service";
            let desc = (o.details || "Service Order").substring(0, 80);
            const signerName = o.handledBy || currentAdminName || "Administrator";

            const doc = new jsPDF();
            doc.setTextColor(59, 130, 246); 
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("SILENT PORTAL", 15, 20);

            doc.setTextColor(0, 0, 0); 
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("Official Order Invoice", 15, 26);

            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text("INVOICE", 195, 20, { align: "right" });
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`Date: ${dateStr}`, 195, 26, { align: "right" });
            doc.text(`Order ID: ${orderId}`, 195, 31, { align: "right" });

            doc.setDrawColor(200, 200, 200);
            doc.line(15, 36, 195, 36);

            doc.setFontSize(11);
            doc.setFont("helvetica", "bold");
            doc.text("Bill To:", 15, 45);
            doc.setFont("helvetica", "normal");
            doc.text(userName, 15, 51);
            doc.setFontSize(9);
            doc.setTextColor(100, 100, 100);
            doc.text(`UID: ${uidShort}`, 15, 56);

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont("helvetica", "bold");
            doc.text("Status:", 195, 45, { align: "right" });
            doc.setDrawColor(0, 0, 0);
            doc.rect(175, 48, 20, 7); 
            doc.setFontSize(10);
            doc.text("PAID", 185, 53, { align: "center" });

            doc.autoTable({
                startY: 65,
                head: [['Description', 'Service Type', 'Amount']],
                body: [[desc, serviceName, formattedPrice]],
                theme: 'striped',
                headStyles: { fillColor: [230, 230, 230], textColor: [0, 0, 0], fontStyle: 'bold' },
                styles: { textColor: [0, 0, 0] },
                columnStyles: { 2: { halign: 'right', fontStyle: 'bold' } }
            });

            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text("TOTAL", 150, finalY);
            doc.setFontSize(14);
            doc.text(formattedPrice, 195, finalY, { align: "right" });

            const pageHeight = doc.internal.pageSize.height;
            const footerY = pageHeight - 40;

            doc.setDrawColor(59, 130, 246);
            doc.setLineWidth(0.5);
            doc.line(15, footerY, 70, footerY); 

            doc.setFont("times", "italic");
            doc.setFontSize(16);
            doc.setTextColor(59, 130, 246); 
            doc.text(signerName, 42, footerY - 5, { align: "center" });

            doc.setFont("helvetica", "normal");
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text("Authorized Signature", 42, footerY + 5, { align: "center" });
            doc.text("Digitally Approved", 42, footerY + 9, { align: "center" });

            doc.text("Thank you for your business!", 195, footerY + 15, { align: "right" });
            doc.text("Generated by Silent Portal System", 195, footerY + 19, { align: "right" });

            doc.save(`Invoice_${o.orderId_visible || 'Order'}.pdf`);
            showToast("Invoice Downloaded!");
        };

        window.downloadDepositInvoice = (key) => {
            const d = allDepositsData[key];
            if(!d) return showToast("Data not found", "error");

            showToast("Generating Receipt...");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const formattedPrice = "Tk " + (d.amount || 0);
            let dateStr = "N/A";
            if(d.timestamp) dateStr = new Date(d.timestamp).toLocaleDateString();
            else dateStr = new Date().toLocaleDateString(); 

            const trxId = d.trxId || "N/A";
            const userName = d.uName || "User";
            const uidShort = d.uid ? d.uid.substring(0,8)+"..." : "N/A";
            const signerName = d.handledBy || currentAdminName || "Administrator";

            doc.setTextColor(59, 130, 246);
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("SILENT PORTAL", 15, 20);

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("Official Deposit Receipt", 15, 26);

            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text("RECEIPT", 195, 20, { align: "right" });
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`Date: ${dateStr}`, 195, 26, { align: "right" });

            doc.setDrawColor(200, 200, 200);
            doc.line(15, 36, 195, 36);

            doc.setFontSize(11);
            doc.setFont("helvetica", "bold");
            doc.text("Received From:", 15, 45);
            doc.setFont("helvetica", "normal");
            doc.text(userName, 15, 51);
            doc.setFontSize(9);
            doc.setTextColor(100, 100, 100);
            doc.text(`UID: ${uidShort}`, 15, 56);
            if(d.accMobile) doc.text(`Mobile: ${d.accMobile}`, 15, 61);

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont("helvetica", "bold");
            doc.text("Status:", 195, 45, { align: "right" });
            doc.setDrawColor(0, 0, 0);
            doc.rect(175, 48, 20, 7);
            doc.setFontSize(10);
            doc.text("PAID", 185, 53, { align: "center" });

            doc.autoTable({
                startY: 70,
                head: [['Description', 'Transaction ID', 'Amount']],
                body: [["Wallet Deposit", trxId, formattedPrice]],
                theme: 'striped',
                headStyles: { fillColor: [230, 230, 230], textColor: [0, 0, 0], fontStyle: 'bold' },
                styles: { textColor: [0, 0, 0] },
                columnStyles: { 2: { halign: 'right', fontStyle: 'bold' } }
            });

            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text("TOTAL RECEIVED", 140, finalY);
            doc.setFontSize(14);
            doc.text(formattedPrice, 195, finalY, { align: "right" });

            const pageHeight = doc.internal.pageSize.height;
            const footerY = pageHeight - 40;

            doc.setDrawColor(59, 130, 246);
            doc.setLineWidth(0.5);
            doc.line(15, footerY, 70, footerY); 

            doc.setFont("times", "italic");
            doc.setFontSize(16);
            doc.setTextColor(59, 130, 246); 
            doc.text(signerName, 42, footerY - 5, { align: "center" });

            doc.setFont("helvetica", "normal");
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text("Authorized Signature", 42, footerY + 5, { align: "center" });
            doc.text("Digitally Approved", 42, footerY + 9, { align: "center" });

            doc.text("Generated by Silent Portal System", 195, footerY + 19, { align: "right" });

            doc.save(`Receipt_${trxId}.pdf`);
            showToast("Receipt Downloaded!");
        };

        window.copyFullOrderInfo = () => { const s = document.getElementById('inf-service').innerText; const d = document.getElementById('inf-details').innerText; const f = document.getElementById('inf-file').innerText; copyToClip(`Service: ${s}\nDetails: ${d}\nLink: ${f}`); };
        window.viewProof = (url) => { document.getElementById('proof-img-src').src = url; document.getElementById('proof-link-src').href = url; document.getElementById('proof-modal').style.display = 'flex'; };
        window.verifyBal = (k,u,a,n,t) => { verifyKey=k; verifyUid=u; document.getElementById('v-uname').innerText=n; document.getElementById('v-trx').innerText=t; document.getElementById('v-claim').innerText="৳ "+a; document.getElementById('v-final-amount').value=a; document.getElementById('bal-verify-modal').style.display='flex'; };
        window.submitBalApproval = async () => { const a = Number(document.getElementById('v-final-amount').value); if(a>0) { const cur = (await get(ref(db, 'users/'+verifyUid+'/balance'))).val() || 0; await update(ref(db, 'users/'+verifyUid), {balance: cur+a}); await update(ref(db, 'balance_requests/'+verifyKey), {status:'approved', approvedAmount:a, handledBy: currentAdminName}); document.getElementById('bal-verify-modal').style.display='none'; showToast("Added!"); } };
        window.openBalanceModal = (uid, name, currentBal) => { currentBalanceEditUid = uid; document.getElementById('bal-edit-uname').innerText = name; document.getElementById('bal-edit-input').value = currentBal; document.getElementById('balance-modal').style.display = 'flex'; };
        window.submitBalanceUpdate = () => { const newBal = Number(document.getElementById('bal-edit-input').value); if(newBal < 0 || isNaN(newBal)) return showToast("Invalid Amount", "error"); if(currentBalanceEditUid) { update(ref(db, 'users/' + currentBalanceEditUid), { balance: newBal }).then(() => { showToast("Balance Updated Successfully"); document.getElementById('balance-modal').style.display = 'none'; }).catch(err => showToast(err.message, "error")); } };
        window.toggleVerify = (uid, status) => { update(ref(db, 'users/' + uid), { isVerified: status }).then(() => showToast(status ? "User Verified!" : "Badge Removed")).catch(err => showToast(err.message, "error")); };
        window.chat = (k) => { 
            activeChat = k; document.getElementById('chat-modal').style.display = 'flex'; document.getElementById('chat-msgs').innerHTML = '<div style="text-align:center;color:#94a3b8;margin-top:20px;">Loading chat...</div>';
            onValue(ref(db, 'chats/'+k), s => {
                const msgs = document.getElementById('chat-msgs'); msgs.innerHTML = "";
                s.forEach(c => {
                    const m = c.val(); const isMe = (m.s !== allOrdersData[k]?.userId);
                    let align = isMe ? 'flex-end' : 'flex-start'; let bg = isMe ? '#3b82f6' : '#1e293b'; let safeText = m.t.replace(/'/g, "\\'");
                    msgs.innerHTML += `<div style="display:flex; justify-content:${align}; margin-bottom:10px; align-items:center;"><div style="background:${bg}; padding:8px 12px; border-radius:15px; max-width:80%; font-size:13px; color:white; position:relative;">${m.t}<i class="fas fa-copy msg-copy-icon" onclick="copyToClip('${safeText}')" title="Copy"></i></div></div>`;
                });
                msgs.scrollTop = msgs.scrollHeight;
            });
        };
        window.sendRep = (txt=null) => { const t = txt || document.getElementById('chat-in').value; if(t && activeChat) { push(ref(db, 'chats/'+activeChat), { s: currentAdminName, t: t }); document.getElementById('chat-in').value = ""; } };
        window.proc = (k) => update(ref(db, 'orders/'+k), { status: 'processing', handledBy: currentAdminName });
        window.comp = (k, uid) => { if(confirm("Mark as Completed?")) { update(ref(db, 'orders/'+k), { status: 'completed', handledBy: currentAdminName, completed_at: Date.now() }); } };
        window.openCancelModal = (k) => { currentCancelOrderId = k; document.getElementById('cancel-modal').style.display='flex'; };
        window.submitCancel = () => {
            const reason = document.getElementById('cancel-reason').value; const refund = document.getElementById('cancel-refund-check').checked;
            if(!reason) return showToast("Enter reason", "error"); const order = allOrdersData[currentCancelOrderId];
            update(ref(db, 'orders/'+currentCancelOrderId), { status: 'cancelled', admin_note: reason, handledBy: currentAdminName }).then(async () => {
                if(refund && order && order.cost) { const userRef = ref(db, 'users/'+order.userId); const snap = await get(userRef); if(snap.exists()) { const curBal = snap.val().balance || 0; await update(userRef, { balance: curBal + Number(order.cost) }); showToast("Order Cancelled & Refunded"); } } else { showToast("Order Cancelled"); } document.getElementById('cancel-modal').style.display='none';
            });
        };
        window.modUser = (key, status) => { if(confirm("Change user status to " + status + "?")) { update(ref(db, 'users/'+key), { status: status }).then(()=>showToast("User updated")); } };
        window.openBanModal = (key) => { currentBanUserId = key; document.getElementById('ban-modal').style.display='flex'; };
        window.submitBan = () => { const r = document.getElementById('ban-reason-input').value; if(!r) return showToast("Enter reason", "error"); update(ref(db, 'users/'+currentBanUserId), { status: 'banned', ban_reason: r }).then(()=>{ document.getElementById('ban-modal').style.display='none'; showToast("User Banned"); }); };
        window.openRejectModal = (k, n, t) => { currentRejectBalKey = k; document.getElementById('rej-info-txt').innerText = `${n} | ${t}`; document.getElementById('bal-reject-modal').style.display='flex'; };
        window.submitBalReject = () => { const r = document.getElementById('rej-reason-inp').value; if(!r) return showToast("Enter reason", "error"); update(ref(db, 'balance_requests/'+currentRejectBalKey), { status: 'rejected', reject_reason: r, handledBy: currentAdminName }).then(()=>{ document.getElementById('bal-reject-modal').style.display='none'; showToast("Rejected"); }); };
    </script>
</body>
</html>
